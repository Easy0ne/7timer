(function(b,a){typeof exports==="object"&&typeof module!=="undefined"?a(exports,require("leaflet"),require("esri-leaflet")):typeof define==="function"&&define.amd?define(["exports","leaflet","esri-leaflet"],a):a(b.L.esri.Geocoding={},L,L.esri)})(this,function(d,k,e){d.Geocode=e.Task.extend({path:"find",params:{outSr:4326,forStorage:false,outFields:"*",maxLocations:20},setters:{address:"address",neighborhood:"neighborhood",city:"city",subregion:"subregion",region:"region",postal:"postal",country:"country",text:"text",category:"category",token:"token",key:"magicKey",fields:"outFields",forStorage:"forStorage",maxLocations:"maxLocations"},initialize:function(m){m=m||{};m.url=m.url||d.WorldGeocodingServiceUrl;e.Task.prototype.initialize.call(this,m)},within:function(m){m=k.latLngBounds(m);this.params.bbox=e.Util.boundsToExtent(m);return this},nearby:function(n,m){n=k.latLng(n);this.params.location=n.lng+","+n.lat;this.params.distance=Math.min(Math.max(m,2000),50000);return this},run:function(n,m){this.path=this.params.text?"find":"findAddressCandidates";if(this.path==="findAddressCandidates"&&this.params.bbox){this.params.searchExtent=this.params.bbox;delete this.params.bbox}return this.request(function(p,o){var r=this.path==="find"?this._processFindResponse:this._processFindAddressCandidatesResponse;var q=!p?r(o):undefined;n.call(m,p,{results:q},o)},this)},_processFindResponse:function(n){var p=[];for(var o=0;o<n.locations.length;o++){var m=n.locations[o];var q;if(m.extent){q=e.Util.extentToBounds(m.extent)}p.push({text:m.name,bounds:q,score:m.feature.attributes.Score,latlng:k.latLng(m.feature.geometry.y,m.feature.geometry.x),properties:m.feature.attributes})}return p},_processFindAddressCandidatesResponse:function(m){var o=[];for(var n=0;n<m.candidates.length;n++){var p=m.candidates[n];var q=e.Util.extentToBounds(p.extent);o.push({text:p.address,bounds:q,score:p.score,latlng:k.latLng(p.location.y,p.location.x),properties:p.attributes})}return o}});function b(m){return new d.Geocode(m)}d.ReverseGeocode=e.Task.extend({path:"reverseGeocode",params:{outSR:4326},setters:{distance:"distance",language:"language"},initialize:function(m){m=m||{};m.url=m.url||d.WorldGeocodingServiceUrl;e.Task.prototype.initialize.call(this,m)},latlng:function(m){m=k.latLng(m);this.params.location=m.lng+","+m.lat;return this},run:function(n,m){return this.request(function(q,p){var o;if(!q){o={latlng:k.latLng(p.location.y,p.location.x),address:p.address}}else{o=undefined}n.call(m,q,o,p)},this)}});function c(m){return new d.ReverseGeocode(m)}d.Suggest=e.Task.extend({path:"suggest",params:{},setters:{text:"text",category:"category"},initialize:function(m){m=m||{};m.url=m.url||d.WorldGeocodingServiceUrl;e.Task.prototype.initialize.call(this,m)},within:function(n){n=k.latLngBounds(n);n=n.pad(0.5);var m=n.getCenter();var o=n.getNorthWest();this.params.location=m.lng+","+m.lat;this.params.distance=Math.min(Math.max(m.distanceTo(o),2000),50000);this.params.searchExtent=e.Util.boundsToExtent(n);return this},nearby:function(n,m){n=k.latLng(n);this.params.location=n.lng+","+n.lat;this.params.distance=Math.min(Math.max(m,2000),50000);return this},run:function(n,m){return this.request(function(p,o){n.call(m,p,o,o)},this)}});function f(m){return new d.Suggest(m)}d.GeocodeService=e.Service.extend({initialize:function(m){m=m||{};m.url=m.url||d.WorldGeocodingServiceUrl;e.Service.prototype.initialize.call(this,m);this._confirmSuggestSupport()},geocode:function(){return b(this)},reverse:function(){return c(this)},suggest:function(){return f(this)},_confirmSuggestSupport:function(){this.metadata(function(n,m){if(n){return}if(m.capabilities.indexOf("Suggest")>=0){this.options.supportsSuggest=true}else{this.options.supportsSuggest=false}},this)}});function g(m){return new d.GeocodeService(m)}d.Geosearch=k.Control.extend({includes:k.Mixin.Events,options:{position:"topleft",zoomToResult:true,useMapBounds:12,collapseAfterResult:true,expanded:false,forStorage:false,allowMultipleResults:true,placeholder:"Search for places or addresses",title:"Location Search"},initialize:function(m){if(!m||!m.providers||!m.providers.length){throw new Error("You must specificy at least one provider")}this._providers=m.providers;for(var n=0;n<this._providers.length;n++){this._providers[n].addEventParent(this)}this._pendingSuggestions=[];k.Control.prototype.initialize.call(m)},_geocode:function(s,p,r){var n=0;var m=[];var q;var t=k.Util.bind(function(u,v){n--;if(u){return}if(v){m=m.concat(v)}if(n<=0){q=this._boundsFromResults(m);this.fire("results",{results:m,bounds:q,latlng:q?q.getCenter():undefined,text:s});k.DomUtil.removeClass(this._input,"geocoder-control-loading");this.fire("load");this.clear();this._input.blur()}},this);if(p){n++;r.results(s,p,this._searchBounds(),t)}else{for(var o=0;o<this._providers.length;o++){n++;this._providers[o].results(s,p,this._searchBounds(),t)}}},_suggest:function(r){k.DomUtil.addClass(this._input,"geocoder-control-loading");var n=this._providers.length;
var m=k.Util.bind(function(t,s){return k.Util.bind(function(w,u){if(w){return}var x;n=n-1;if(this._input.value<2){this._suggestions.innerHTML="";this._suggestions.style.display="none";return}if(u){for(x=0;x<u.length;x++){u[x].provider=s}}if(s._lastRender!==t&&s.nodes){for(x=0;x<s.nodes.length;x++){if(s.nodes[x].parentElement){this._suggestions.removeChild(s.nodes[x])}}s.nodes=[]}if(u.length&&this._input.value===t){if(s.nodes){for(var v=0;v<s.nodes.length;v++){if(s.nodes[v].parentElement){this._suggestions.removeChild(s.nodes[v])}}}s._lastRender=t;s.nodes=this._renderSuggestions(u)}if(n===0){k.DomUtil.removeClass(this._input,"geocoder-control-loading")}},this)},this);this._pendingSuggestions=[];for(var o=0;o<this._providers.length;o++){var q=this._providers[o];var p=q.suggestions(r,this._searchBounds(),m(r,q));this._pendingSuggestions.push(p)}},_searchBounds:function(){if(this.options.useMapBounds===false){return null}if(this.options.useMapBounds===true){return this._map.getBounds()}if(this.options.useMapBounds<=this._map.getZoom()){return this._map.getBounds()}return null},_renderSuggestions:function(n){var r;this._suggestions.style.display="block";this._suggestions.style.maxHeight=this._map.getSize().y-this._suggestions.offsetTop-this._wrapper.offsetTop-10+"px";var p=[];var s;var t;for(var q=0;q<n.length;q++){var o=n[q];if(!t&&this._providers.length>1&&r!==o.provider.options.label){t=k.DomUtil.create("span","geocoder-control-header",this._suggestions);t.textContent=o.provider.options.label;t.innerText=o.provider.options.label;r=o.provider.options.label;p.push(t)}if(!s){s=k.DomUtil.create("ul","geocoder-control-list",this._suggestions)}var m=k.DomUtil.create("li","geocoder-control-suggestion",s);m.innerHTML=o.text;m.provider=o.provider;m["data-magic-key"]=o.magicKey}p.push(s);return p},_boundsFromResults:function(p){if(!p.length){return}var n=k.latLngBounds([0,0],[0,0]);var q=k.latLngBounds([0,0],[0,0]);for(var o=p.length-1;o>=0;o--){var m=p[o];if(m.bounds&&m.bounds.isValid()&&!m.bounds.equals(n)){q.extend(m.bounds)}q.extend(m.latlng)}return q},clear:function(){this._suggestions.innerHTML="";this._suggestions.style.display="none";this._input.value="";if(this.options.collapseAfterResult){this._input.placeholder="";k.DomUtil.removeClass(this._wrapper,"geocoder-control-expanded")}if(!this._map.scrollWheelZoom.enabled()&&this._map.options.scrollWheelZoom){this._map.scrollWheelZoom.enable()}},getAttribution:function(){var m=this.options.attribution;for(var n=0;n<this._providers.length;n++){m+=" "+this._providers[n].options.attribution}return m},onAdd:function(m){this._map=m;this._wrapper=k.DomUtil.create("div","geocoder-control "+(this.options.expanded?" "+"geocoder-control-expanded":""));this._input=k.DomUtil.create("input","geocoder-control-input leaflet-bar",this._wrapper);this._input.title=this.options.title;this._suggestions=k.DomUtil.create("div","geocoder-control-suggestions leaflet-bar",this._wrapper);k.DomEvent.addListener(this._input,"focus",function(n){this._input.placeholder=this.options.placeholder;k.DomUtil.addClass(this._wrapper,"geocoder-control-expanded")},this);k.DomEvent.addListener(this._wrapper,"click",function(n){k.DomUtil.addClass(this._wrapper,"geocoder-control-expanded");this._input.focus()},this);k.DomEvent.addListener(this._suggestions,"mousedown",function(o){var n=o.target||o.srcElement;this._geocode(n.innerHTML,n["data-magic-key"],n.provider);this.clear()},this);k.DomEvent.addListener(this._input,"blur",function(n){this.clear()},this);k.DomEvent.addListener(this._input,"keydown",function(s){k.DomUtil.addClass(this._wrapper,"geocoder-control-expanded");var t=this._suggestions.querySelectorAll("."+"geocoder-control-suggestion");var p=this._suggestions.querySelectorAll("."+"geocoder-control-selected")[0];var v;for(var q=0;q<t.length;q++){if(t[q]===p){v=q;break}}switch(s.keyCode){case 13:if(p){this._geocode(p.innerHTML,p["data-magic-key"],p.provider);this.clear()}else{if(this.options.allowMultipleResults){this._geocode(this._input.value,undefined);this.clear()}else{k.DomUtil.addClass(t[0],"geocoder-control-selected")}}k.DomEvent.preventDefault(s);break;case 38:if(p){k.DomUtil.removeClass(p,"geocoder-control-selected")}var r=t[v-1];if(p&&r){k.DomUtil.addClass(r,"geocoder-control-selected")}else{k.DomUtil.addClass(t[t.length-1],"geocoder-control-selected")}k.DomEvent.preventDefault(s);break;case 40:if(p){k.DomUtil.removeClass(p,"geocoder-control-selected")}var n=t[v+1];if(p&&n){k.DomUtil.addClass(n,"geocoder-control-selected")}else{k.DomUtil.addClass(t[0],"geocoder-control-selected")}k.DomEvent.preventDefault(s);break;default:for(var u=0;u<this._pendingSuggestions.length;u++){var o=this._pendingSuggestions[u];if(o&&o.abort&&!o.id){o.abort()}}break}},this);k.DomEvent.addListener(this._input,"keyup",k.Util.throttle(function(o){var n=o.which||o.keyCode;var p=(o.target||o.srcElement).value;if(p.length<2){this._suggestions.innerHTML="";this._suggestions.style.display="none";k.DomUtil.removeClass(this._input,"geocoder-control-loading");
return}if(n===27){this._suggestions.innerHTML="";this._suggestions.style.display="none";return}if(n!==13&&n!==38&&n!==40){if(this._input.value!==this._lastValue){this._lastValue=this._input.value;this._suggest(p)}}},50,this),this);k.DomEvent.disableClickPropagation(this._wrapper);k.DomEvent.addListener(this._suggestions,"mouseover",function(n){if(m.scrollWheelZoom.enabled()&&m.options.scrollWheelZoom){m.scrollWheelZoom.disable()}});k.DomEvent.addListener(this._suggestions,"mouseout",function(n){if(!m.scrollWheelZoom.enabled()&&m.options.scrollWheelZoom){m.scrollWheelZoom.enable()}});return this._wrapper},onRemove:function(m){m.attributionControl.removeAttribution("Geocoding by Esri")}});function j(m){return new d.Geosearch(m)}d.ArcgisOnlineProvider=d.GeocodeService.extend({options:{label:"Places and Addresses",maxResults:5,attribution:'<a href="https://developers.arcgis.com/en/features/geocoding/">Geocoding by Esri</a>'},suggestions:function(o,n,p){var m=this.suggest().text(o);if(n){m.within(n)}return m.run(function(t,u,s){var q=[];if(!t){while(s.suggestions.length&&q.length<=this.options.maxResults-1){var r=s.suggestions.shift();if(!r.isCollection){q.push({text:r.text,magicKey:r.magicKey})}}}p(t,q)},this)},results:function(p,m,o,q){var n=this.geocode().text(p);if(m){n.key(m)}else{n.maxLocations(this.options.maxResults)}if(o){n.within(o)}if(this.options.forStorage){n.forStorage(true)}return n.run(function(s,r){q(s,r.results)},this)}});function i(m){return new d.ArcgisOnlineProvider(m)}d.FeatureLayerProvider=e.FeatureLayerService.extend({options:{label:"Feature Layer",maxResults:5,bufferRadius:1000,formatSuggestion:function(m){return m.properties[this.options.searchFields[0]]}},initialize:function(m){e.FeatureLayerService.prototype.initialize.call(this,m);if(typeof this.options.searchFields==="string"){this.options.searchFields=[this.options.searchFields]}},suggestions:function(p,n,q){var o=this.query().where(this._buildQuery(p)).returnGeometry(false);if(n){o.intersects(n)}if(this.options.idField){o.fields([this.options.idField].concat(this.options.searchFields))}var m=o.run(function(t,w,s){if(t){q(t,[])}else{this.options.idField=s.objectIdFieldName;var r=[];var x=Math.min(w.features.length,this.options.maxResults);for(var v=0;v<x;v++){var u=w.features[v];r.push({text:this.options.formatSuggestion.call(this,u),magicKey:u.id})}q(t,r.slice(0,this.options.maxResults).reverse())}},this);return m},results:function(p,m,n,q){var o=this.query();if(m){o.featureIds([m])}else{o.where(this._buildQuery(p))}if(n){o.within(n)}return o.run(k.Util.bind(function(s,w){var v=[];for(var u=0;u<w.features.length;u++){var t=w.features[u];if(t){var x=this._featureBounds(t);var r={latlng:x.getCenter(),bounds:x,text:this.options.formatSuggestion.call(this,t),properties:t.properties};v.push(r)}}q(s,v)},this))},_buildQuery:function(o){var p=[];for(var m=this.options.searchFields.length-1;m>=0;m--){var n=this.options.searchFields[m];p.push(n+" LIKE '%"+o+"%'")}return p.join(" OR ")},_featureBounds:function(o){var n=k.geoJson(o);if(o.geometry.type==="Point"){var m=n.getBounds().getCenter();var q=this.options.bufferRadius/40075017*360/Math.cos(180/Math.PI*m.lat);var p=this.options.bufferRadius/40075017*360;return k.latLngBounds([m.lat-p,m.lng-q],[m.lat+p,m.lng+q])}else{return n.getBounds()}}});function h(m){return new d.FeatureLayerProvider(m)}d.MapServiceProvider=e.MapService.extend({options:{layers:[0],label:"Map Service",bufferRadius:1000,maxResults:5,formatSuggestion:function(m){return m.properties[m.displayFieldName]+" <small>"+m.layerName+"</small>"}},initialize:function(m){e.MapService.prototype.initialize.call(this,m);this._getIdFields()},suggestions:function(o,n,p){var m=this.find().text(o).fields(this.options.searchFields).returnGeometry(false).layers(this.options.layers);return m.run(function(w,r,x){var v=[];if(!w){var u=Math.min(this.options.maxResults,r.features.length);x.results=x.results.reverse();for(var s=0;s<u;s++){var y=r.features[s];var z=x.results[s];var t=z.layerId;var q=this._idFields[t];y.layerId=t;y.layerName=this._layerNames[t];y.displayFieldName=this._displayFields[t];if(q){v.push({text:this.options.formatSuggestion.call(this,y),magicKey:z.attributes[q]+":"+t})}}}p(w,v.reverse())},this)},results:function(s,o,q,t){var n=[];var p;if(o){var r=o.split(":")[0];var m=o.split(":")[1];p=this.query().layer(m).featureIds(r)}else{p=this.find().text(s).fields(this.options.searchFields).contains(false).layers(this.options.layers)}return p.run(function(w,z,v){if(!w){if(v.results){v.results=v.results.reverse()}for(var y=0;y<z.features.length;y++){var x=z.features[y];m=m?m:v.results[y].layerId;if(x&&m!==undefined){var A=this._featureBounds(x);x.layerId=m;x.layerName=this._layerNames[m];x.displayFieldName=this._displayFields[m];var u={latlng:A.getCenter(),bounds:A,text:this.options.formatSuggestion.call(this,x),properties:x.properties};n.push(u)}}}t(w,n.reverse())},this)},_featureBounds:function(o){var n=k.geoJson(o);if(o.geometry.type==="Point"){var m=n.getBounds().getCenter();
var q=this.options.bufferRadius/40075017*360/Math.cos(180/Math.PI*m.lat);var p=this.options.bufferRadius/40075017*360;return k.latLngBounds([m.lat-p,m.lng-q],[m.lat+p,m.lng+q])}else{return n.getBounds()}},_layerMetadataCallback:function(m){return k.Util.bind(function(n,p){if(n){return}this._displayFields[m]=p.displayField;this._layerNames[m]=p.name;for(var o=0;o<p.fields.length;o++){var q=p.fields[o];if(q.type==="esriFieldTypeOID"){this._idFields[m]=q.name;break}}},this)},_getIdFields:function(){this._idFields={};this._displayFields={};this._layerNames={};for(var n=0;n<this.options.layers.length;n++){var m=this.options.layers[n];this.get(m,{},this._layerMetadataCallback(m))}}});function l(m){return new d.MapServiceProvider(m)}d.GeocodeServiceProvider=d.GeocodeService.extend({options:{label:"Geocode Server",maxResults:5},suggestions:function(o,n,p){if(this.options.supportsSuggest){var m=this.suggest().text(o);if(n){m.within(n)}return m.run(function(t,u,s){var q=[];if(!t){while(s.suggestions.length&&q.length<=this.options.maxResults-1){var r=s.suggestions.shift();if(!r.isCollection){q.push({text:r.text,magicKey:r.magicKey})}}}p(t,q)},this)}else{p(undefined,[]);return false}},results:function(p,m,o,q){var n=this.geocode().text(p);n.maxLocations(this.options.maxResults);if(o){n.within(o)}return n.run(function(s,r){q(s,r.results)},this)}});function a(m){return new d.GeocodeServiceProvider(m)}d.VERSION="2.0.0-beta.3";d.WorldGeocodingServiceUrl=(window.location.protocol==="https:"?"https:":"http:")+"//geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/";d.geocode=b;d.reverseGeocode=c;d.suggest=f;d.geocodeService=g;d.geosearch=j;d.arcgisOnlineProvider=i;d.featureLayerProvider=h;d.mapServiceProvider=l;d.geocodeServiceProvider=a});